<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0b0c1e">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Payments">
<title>Payments</title>
<style>
:root {
  --bg:#0b0c1e;--bg2:#0f1028;--bg3:#131430;--card:#0e1030;--cardh:#131540;
  --border:#1c1f3a;--acc:#4f46e5;--acc2:#818cf8;--txt:#e0e4f8;--txt2:#5560a0;
  --txt3:#2d3060;--red:#ef4444;--green:#10b981;--amber:#f59e0b;
  --sans:system-ui,-apple-system,sans-serif;--mono:ui-monospace,'SF Mono',monospace;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:var(--sans);}

.hdr{position:sticky;top:0;z-index:50;background:rgba(11,12,30,.97);backdrop-filter:blur(18px);border-bottom:1px solid var(--border);padding:13px 15px 11px;}
.hdr-row1{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.logo{font-size:11px;font-weight:700;letter-spacing:.22em;text-transform:uppercase;color:var(--txt2);font-family:var(--mono);}
.mode-tabs{display:flex;gap:4px;}
.mtab{font-family:var(--mono);font-size:11px;padding:4px 10px;border-radius:7px;border:1px solid var(--border);background:var(--bg3);color:var(--txt3);cursor:pointer;transition:all .15s;white-space:nowrap;}
.mtab.on{background:rgba(79,70,229,.18);border-color:var(--acc);color:var(--acc2);}
.month-nav{display:none;align-items:center;justify-content:space-between;margin-bottom:10px;}
.month-nav.on{display:flex;}
.mnav-btn{background:var(--bg3);border:1px solid var(--border);color:var(--txt2);width:34px;height:34px;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.mnav-lbl{font-family:var(--mono);font-size:13px;color:var(--txt);font-weight:500;}
.srch-wrap{position:relative;}
.srch-ico{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--txt3);pointer-events:none;}
.srch{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:11px;padding:9px 34px;color:var(--txt);font-family:var(--mono);font-size:13px;outline:none;transition:border-color .2s;}
.srch::placeholder{color:var(--txt3);}
.srch:focus{border-color:var(--acc);}
.srch-x{position:absolute;right:9px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--txt3);font-size:14px;cursor:pointer;padding:4px;display:none;}
.srch-x.on{display:block;}

.list{padding:10px 13px 90px;}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;margin-bottom:8px;overflow:hidden;transition:border-color .2s;}
.card.expanded{border-color:rgba(79,70,229,.5);}
.card-main{display:flex;align-items:center;gap:11px;padding:13px 14px;cursor:pointer;user-select:none;}
.card-main:active{background:var(--cardh);}
.c-ico{width:40px;height:40px;border-radius:12px;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;}
.c-body{flex:1;min-width:0;}
.c-top{display:flex;justify-content:space-between;align-items:baseline;gap:8px;}
.c-name{font-weight:700;font-size:14.5px;color:var(--txt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.c-amt{font-family:var(--mono);font-size:14px;color:var(--txt);white-space:nowrap;flex-shrink:0;font-weight:500;}
.c-bot{display:flex;align-items:center;gap:7px;margin-top:4px;}
.c-date{font-family:var(--mono);font-size:12px;color:var(--txt2);}
mark{background:rgba(79,70,229,.35);color:var(--acc2);border-radius:3px;padding:0 1px;font-style:normal;}

.card-panel{display:none;border-top:1px solid var(--border);padding:11px 14px 13px;background:rgba(5,6,20,.65);}
.card.expanded .card-panel{display:block;}
.panel-filename{display:flex;align-items:center;gap:6px;background:rgba(79,70,229,.08);border:1px solid rgba(79,70,229,.2);border-radius:10px;padding:7px 10px;margin-bottom:10px;font-family:var(--mono);font-size:11px;color:var(--acc2);word-break:break-all;line-height:1.4;}
.panel-no-file{font-family:var(--mono);font-size:11px;color:var(--txt3);margin-bottom:10px;}
.panel-actions{display:flex;gap:7px;}
.pact-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:9px 8px;font-family:var(--mono);font-size:11px;color:var(--txt2);cursor:pointer;transition:border-color .15s,color .15s;white-space:nowrap;}
.pact-btn.sim{border-color:rgba(245,158,11,.25);color:var(--amber);}
.pact-btn.del{border-color:rgba(239,68,68,.25);color:var(--red);}
.similar-list{display:none;margin-top:10px;}
.similar-list.on{display:block;}
.sim-hdr{font-family:var(--mono);font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--txt3);margin-bottom:6px;}
.sim-hdr b{color:var(--amber);font-weight:400;}
.sim-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);}
.sim-row:last-child{border-bottom:none;}
.sim-ico{font-size:14px;flex-shrink:0;}
.sim-body{flex:1;min-width:0;}
.sim-name{font-size:12.5px;font-weight:600;color:var(--txt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sim-date{font-family:var(--mono);font-size:10px;color:var(--txt3);margin-top:2px;}
.sim-amt{font-family:var(--mono);font-size:12px;color:var(--txt);white-space:nowrap;flex-shrink:0;}
.sim-none{font-family:var(--mono);font-size:11px;color:var(--txt3);padding:6px 0;}

.grp-card{background:var(--card);border:1px solid var(--border);border-radius:18px;margin-bottom:8px;overflow:hidden;}
.grp-hdr{display:flex;align-items:center;gap:10px;padding:13px 14px;cursor:pointer;}
.grp-hdr:active{background:var(--cardh);}
.grp-arrow{color:var(--txt3);transition:transform .2s;flex-shrink:0;}
.grp-card.open .grp-arrow{transform:rotate(90deg);}
.grp-body{display:none;border-top:1px solid var(--border);}
.grp-card.open .grp-body{display:block;}
.grp-row{display:flex;align-items:center;padding:9px 14px 9px 65px;border-bottom:1px solid var(--border);gap:8px;}
.grp-row:last-child{border-bottom:none;}
.grp-row-left{flex:1;min-width:0;}
.grp-row-date{font-family:var(--mono);font-size:12px;color:var(--txt2);}
.grp-row-file{font-family:var(--mono);font-size:10px;color:var(--acc2);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px;}
.grp-row-amt{font-family:var(--mono);font-size:13px;color:var(--txt);white-space:nowrap;}
.grp-count{font-family:var(--mono);font-size:11px;color:var(--txt3);}

.empty{display:none;text-align:center;padding:70px 20px;color:var(--txt3);}
.empty.on{display:block;}
.empty-t{font-size:15px;color:var(--txt2);margin:14px 0 5px;}
.empty-s{font-family:var(--mono);font-size:12px;}

/* Saving indicator */
.save-toast{position:fixed;top:80px;left:50%;transform:translateX(-50%) translateY(-20px);background:rgba(16,185,129,.15);border:1px solid rgba(16,185,129,.4);color:#10b981;font-family:var(--mono);font-size:12px;padding:7px 14px;border-radius:20px;z-index:999;opacity:0;pointer-events:none;transition:all .3s;}
.save-toast.on{opacity:1;transform:translateX(-50%) translateY(0);}

.export-btn{position:fixed;bottom:26px;left:18px;z-index:100;height:40px;padding:0 14px;border-radius:20px;background:var(--bg3);border:1px solid var(--border);color:var(--txt2);font-family:var(--mono);font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px;}
.fab{position:fixed;bottom:24px;right:18px;z-index:100;width:54px;height:54px;border-radius:50%;background:var(--acc);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 22px rgba(79,70,229,.55);transition:transform .2s;}
.fab:active{transform:scale(.94);}
.fab svg{color:#fff;transition:transform .25s;}
.fab.open svg{transform:rotate(45deg);}

.ovl{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:opacity .3s;}
.ovl.on{opacity:1;pointer-events:auto;}
.sheet{position:fixed;bottom:0;left:0;right:0;z-index:300;background:var(--bg2);border-top:1px solid var(--border);border-radius:22px 22px 0 0;padding:0 17px 38px;transform:translateY(100%);transition:transform .34s cubic-bezier(.32,.72,0,1);max-height:93dvh;overflow-y:auto;}
.sheet.on{transform:translateY(0);}
.sh-handle{width:34px;height:4px;background:var(--border);border-radius:2px;margin:11px auto 17px;}
.sh-title{font-size:18px;font-weight:700;margin-bottom:18px;}
.fld{margin-bottom:13px;}
.fld label{display:block;font-family:var(--mono);font-size:10px;letter-spacing:.14em;text-transform:uppercase;color:var(--txt3);margin-bottom:5px;}
.fld input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:11px;padding:12px;color:var(--txt);font-family:var(--sans);font-size:15px;outline:none;transition:border-color .2s;appearance:none;}
.fld input:focus{border-color:var(--acc);}
.fld input::placeholder{color:var(--txt3);}
input[type=date]::-webkit-calendar-picker-indicator{filter:invert(.4);cursor:pointer;}
.upzone{border:1.5px dashed var(--border);border-radius:11px;padding:16px;text-align:center;cursor:pointer;transition:border-color .2s,background .2s;position:relative;}
.upzone:hover,.upzone.has{border-color:var(--acc);background:rgba(79,70,229,.05);}
.upzone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;padding:0;}
.up-txt{font-family:var(--mono);font-size:12px;color:var(--txt3);}
.up-fn{font-family:var(--mono);font-size:12px;color:var(--acc2);margin-top:3px;word-break:break-all;}
.btn-row{display:flex;gap:8px;margin-top:5px;}
.btn-save{flex:1;background:var(--acc);border:none;border-radius:13px;padding:14px;color:#fff;font-family:var(--sans);font-size:15px;font-weight:700;cursor:pointer;}
.btn-cancel{background:var(--bg3);border:1px solid var(--border);border-radius:13px;padding:14px 18px;color:var(--txt2);font-family:var(--sans);font-size:15px;cursor:pointer;}
.divider{border:none;border-top:1px solid var(--border);margin:16px 0 13px;}
.sec-lbl{font-family:var(--mono);font-size:10px;letter-spacing:.14em;text-transform:uppercase;color:var(--txt3);margin-bottom:9px;}
.card.rm{animation:rmOut .24s ease both;}
@keyframes rmOut{to{opacity:0;transform:translateX(28px);max-height:0;padding:0;margin:0;border:none;}}
</style>
</head>
<body>

<div class="save-toast" id="toast">‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>

<header class="hdr">
  <div class="hdr-row1">
    <div class="logo">Payments</div>
    <div class="mode-tabs">
      <div class="mtab on" onclick="setMode('list',this)">–°–ø–∏—Å–æ–∫</div>
      <div class="mtab" onclick="setMode('month',this)">–ú–µ—Å—è—Ü</div>
      <div class="mtab" onclick="setMode('group',this)">–°–µ—Ä–≤–∏—Å</div>
    </div>
  </div>
  <div class="month-nav" id="monthNav">
    <button class="mnav-btn" onclick="shiftMonth(-1)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg></button>
    <span class="mnav-lbl" id="monthLbl"></span>
    <button class="mnav-btn" onclick="shiftMonth(1)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg></button>
  </div>
  <div class="srch-wrap">
    <svg class="srch-ico" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input class="srch" id="si" type="text" placeholder="–ü–æ–∏—Å–∫‚Ä¶">
    <button class="srch-x" id="sx" onclick="clrS()">‚úï</button>
  </div>
</header>

<div class="list" id="list">
  <div class="empty" id="emp">
    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:.2;margin:auto;display:block"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/></svg>
    <div class="empty-t">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
    <div class="empty-s">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å</div>
  </div>
</div>

<button class="export-btn" onclick="exportXlsx()">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
  Excel
</button>

<button class="fab" id="fab" onclick="toggleSh()">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
</button>

<div class="ovl" id="ovl" onclick="closeSh()"></div>
<div class="sheet" id="sh">
  <div class="sh-handle"></div>
  <div class="sh-title" id="shTitle">–ù–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂</div>
  <input type="hidden" id="editId">
  <div class="fld"><label>–°–µ—Ä–≤–∏—Å / –ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="fS" placeholder="Google Workspace, Adobe‚Ä¶" autocomplete="off"></div>
  <div class="fld"><label>–°—É–º–º–∞ (‚Ç¥)</label><input type="number" id="fA" placeholder="0.00" step="0.01" min="0" inputmode="decimal"></div>
  <div class="fld"><label>–î–∞—Ç–∞</label><input type="date" id="fD"></div>
  <div class="fld">
    <label>–ö–≤–∏—Ç–∞–Ω—Ü–∏—è</label>
    <div class="upzone" id="uz">
      <input type="file" id="ff" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" onchange="onF(this)">
      <div class="up-txt">–í—ã–±–µ—Ä–∏—Ç–µ PDF –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
      <div class="up-fn" id="ufn"></div>
    </div>
  </div>
  <div class="btn-row">
    <button class="btn-cancel" onclick="closeSh()">–û—Ç–º–µ–Ω–∞</button>
    <button class="btn-save" onclick="saveEntry()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
  <hr class="divider">
  <div class="sec-lbl">–ò–º–ø–æ—Ä—Ç –∏–∑ Excel (.xlsx)</div>
  <div class="upzone" id="xz">
    <input type="file" id="xf" accept=".xlsx" onchange="importX(this)">
    <div class="up-txt">Payments.xlsx</div>
    <div class="up-fn" id="xfn"></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ XLSX lazy load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _xlsxLoaded = false;
function loadXLSX(){
  return new Promise((res,rej)=>{
    if(_xlsxLoaded){res();return;}
    const s=document.createElement('script');
    s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    s.onload=()=>{_xlsxLoaded=true;res();};s.onerror=rej;
    document.head.appendChild(s);
  });
}

// ‚îÄ‚îÄ SEED (–Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø—É—Å—Ç–æ–µ) ‚îÄ‚îÄ
const SEED=[
  {id:'i99',date:'2026-02-17',service:'Google Workspace',amount:850,filename:'receipt_BM6A-46X2-E8XX-HK3L.pdf'},
  {id:'i98',date:'2026-02-16',service:'AzureNet Databases',amount:2699,filename:'receipt_XXKH-A02M-2PEK-UL52.pdf'},
  {id:'i97',date:'2026-02-15',service:'SUNO INC.',amount:410,filename:'receipt_0X18-416P-2BX4-KPC6.pdf'},
  {id:'i96',date:'2026-02-15',service:'PyCharm',amount:2999,filename:'receipt_XXKH-A02M-2PEK-HK93 (1).pdf'},
  {id:'i95',date:'2026-02-14',service:'Chat Gpt Plus',amount:1530,filename:'receipt_528H-49B9-MH8P-4K1T.pdf'},
  {id:'i94',date:'2026-02-12',service:'Google*PicsArt',amount:750,filename:'receipt_5P5T-KB8P-X801-L5G2 (2).pdf'},
  {id:'i93',date:'2026-02-11',service:'Google*Suno AI',amount:499,filename:'receipt_5P5T-KB8P-X801-L9K3.pdf'},
  {id:'i92',date:'2026-02-11',service:'Adobe Edit Tools',amount:499,filename:'receipt_5P5T-KB8P-X801-E2K2.pdf'},
  {id:'i91',date:'2026-02-10',service:'Firebase AI (Google Services)',amount:1895,filename:'receipt_X6C6-08T0-9BHM-05K6.pdf'},
  {id:'i90',date:'2026-02-09',service:'Open AI Codex',amount:1999,filename:'receipt_5P5T-KB8P-X801-H4G1.pdf'},
  {id:'i89',date:'2026-02-06',service:'JetBrains AI Web Toolkit',amount:2300,filename:'receipt_5P5T-KB8P-X801-D4T9.pdf'},
  {id:'i88',date:'2026-02-03',service:'Android Studio',amount:2699,filename:'receipt_5P5T-KB8P-X801-D4T7.pdf'},
  {id:'i87',date:'2026-02-02',service:'Google*AI Development Tools',amount:1900,filename:'receipt_5694-EH3X-XH0A-Q1L6 (1).pdf'},
  {id:'i86',date:'2026-02-01',service:'Figma Web',amount:2999,filename:'receipt_8BCM-5E01-BK1E-K2U1.pdf'},
  {id:'i85',date:'2026-01-31',service:'Cursor AI',amount:2100,filename:'receipt_5694-EH3X-XH0A-K2U9.pdf'},
  {id:'i84',date:'2026-01-30',service:'Mistral AI',amount:1300,filename:'receipt_5694-EH3X-XH0A-W2H4.pdf'},
  {id:'i83',date:'2026-01-25',service:'Visual Studio Code',amount:1650,filename:'receipt_5694-EH3X-XH0A-J7H2.pdf'},
  {id:'i82',date:'2026-01-24',service:'Hugging Face AI',amount:679,filename:'receipt_5694-EH3X-XH0A-K4N3.pdf'},
  {id:'i81',date:'2026-01-21',service:'Android Studio',amount:1999,filename:'receipt_5694-EH3X-XH0A-B7L1.pdf'},
  {id:'i80',date:'2026-01-19',service:'Google*Suno AI',amount:499,filename:'receipt_5694-EH3X-XH0A-B7G5.pdf'},
  {id:'i79',date:'2026-01-18',service:'Google*Suno AI',amount:499,filename:'receipt_5694-EH3X-XH0A-B7G8.pdf'},
  {id:'i78',date:'2026-01-16',service:'Google*Suno AI',amount:299,filename:'receipt_5694-EH3X-XH0A-B7I2.pdf'},
  {id:'i77',date:'2026-01-16',service:'Firebase Studio AI',amount:1499,filename:'receipt_5694-EH3X-XH0A-B7O2.pdf'},
  {id:'i76',date:'2026-01-14',service:'Chat Gpt Plus',amount:1400,filename:'receipt_5694-EH3X-XH0A-B7K4.pdf'},
  {id:'i75',date:'2026-01-11',service:'Jet Brains Products',amount:1900,filename:'receipt_5694-EH3X-XH0A-B7H9.pdf'},
  {id:'i74',date:'2026-01-05',service:'Google Payments',amount:1200,filename:'receipt_5694-EH3X-XH0A-B7H5.pdf'},
  {id:'i73',date:'2026-01-05',service:'PyCharm',amount:3000,filename:'receipt_5TP2-3E7X-13MP-EHTA.pdf'},
  {id:'i72',date:'2026-01-05',service:'Adobe Web view',amount:1800,filename:'receipt_5694-EH3X-XH0A-B7H8.pdf'},
  {id:'i71',date:'2026-01-04',service:'Android Studio',amount:2340,filename:'receipt_5P5T-KB8P-X801-KC30.pdf'},
  {id:'i70',date:'2026-01-04',service:'Claude',amount:2100,filename:'receipt_5694-EH3X-XH0A-B7H6.pdf'},
  {id:'i69',date:'2026-01-03',service:'Cursor AI',amount:1514,filename:'receipt_H313-X6PT-T6MK-98PY.pdf'},
  {id:'i68',date:'2026-01-02',service:'Github Copilot',amount:2050,filename:'receipt_H313-X6PT-T6MK-98PM.pdf'},
  {id:'i67',date:'2026-01-02',service:'Microsoft AzureNet',amount:1100,filename:'receipt_843K-XB7T-8BB1-8KAI.pdf'},
  {id:'i66',date:'2026-01-01',service:'BETKING.COM.UA',amount:500,filename:'receipt_8HX4-73K8-64ET-49TK.pdf'},
  {id:'i65',date:'2026-01-01',service:'Visual Studio Code',amount:2999,filename:'receipt_843K-XB7T-8BB1-8KEA.pdf'},
  {id:'i64',date:'2026-01-01',service:'–í–æ–ª–æ–¥–∏–º–∏—Ä –ó.',amount:600,filename:'receipt_XTC0-749E-CH21-E46H.pdf'},
  {id:'i63',date:'2026-01-01',service:'Google LLC Gemini',amount:1589,filename:'receipt_843K-XB7T-8BB1-8KAC.pdf'},
  {id:'i62',date:'2025-12-27',service:'Google*Suno',amount:499,filename:'–î–µ—Ä–∂–∞–≤–Ω–∏–π_—Å–µ—Ä–≤—Å_2.pdf'},
  {id:'i61',date:'2025-12-27',service:'Google*Payment',amount:337,filename:'–î–µ—Ä–∂–∞–≤–Ω–∏–π_—Å–µ—Ä–≤—Å.pdf'},
  {id:'i60',date:'2025-12-26',service:'Jet Brains (Smart Bots)',amount:2199,filename:'receipt_8BCM-5E01-BK1E-P4K7.pdf'},
  {id:'i59',date:'2025-12-26',service:'Figma Web',amount:2999,filename:'receipt_8BCM-5E01-BK1E-P4K8.pdf'},
  {id:'i58',date:'2025-12-25',service:'XeAI Perplexity',amount:1339,filename:'receipt_8BCM-5E01-BK1E-P4E9.pdf'},
  {id:'i57',date:'2025-12-22',service:'Firebase AI (Google LLC)',amount:1499,filename:'receipt_8BCM-5E01-BK1E-P4L2.pdf'},
  {id:'i56',date:'2025-12-19',service:'Jet Brains',amount:2255,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_16_12_2025.pdf'},
  {id:'i55',date:'2025-12-19',service:'Open AI',amount:1490,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_16_12_2025.pdf'},
  {id:'i54',date:'2025-12-16',service:'Google Workspace',amount:290,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_16_12_2025.pdf'},
  {id:'i53',date:'2025-12-16',service:'Mistral',amount:1390,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_16_12_2025.pdf'},
  {id:'i52',date:'2025-12-16',service:'Commet AI',amount:1690,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_16_12_2025.pdf'},
  {id:'i51',date:'2025-12-15',service:'Hugging Face',amount:1700,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_15_12_2025.pdf'},
  {id:'i50',date:'2025-12-15',service:'Cursor IDE',amount:1900,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_15_12_2025.pdf'},
  {id:'i49',date:'2025-12-14',service:'Google',amount:1420,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_13_12_2025.pdf'},
  {id:'i48',date:'2025-12-14',service:'Jet Brains',amount:1475,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_14_12_2025.pdf'},
  {id:'i47',date:'2025-12-14',service:'Sonnet Claude',amount:1230,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_13_12_2025.pdf'},
  {id:'i46',date:'2025-12-12',service:'Anthropic',amount:1200,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_12_12_2025.pdf'},
  {id:'i45',date:'2025-12-10',service:'AI Images',amount:1150,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_10_12_2025.pdf'},
  {id:'i44',date:'2025-12-09',service:'Adobe',amount:1899,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_09_12_2025.pdf'},
  {id:'i43',date:'2025-12-06',service:'Cusror AI',amount:2150,filename:'receipt_97XP-8807-66A8-T5PK.pdf'},
  {id:'i42',date:'2025-12-05',service:'Microsoft AzureNet',amount:1100,filename:'receipt_PAMB-88X7-7T8B-M191.pdf'},
  {id:'i41',date:'2025-12-03',service:'Github Copilot',amount:1790,filename:'receipt_4CP3-A2P2-89X5-THXT.pdf'},
  {id:'i40',date:'2025-12-02',service:'Google LLC',amount:470,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_29_11_2025.pdf'},
  {id:'i39',date:'2025-12-02',service:'GOOGLE *Suno',amount:450,filename:'receipt_EB5E-8TCE-46MH-36T2.pdf'},
  {id:'i38',date:'2025-12-02',service:'GOOGLE *GitHub',amount:1790,filename:'receipt_EB5E-8TCE-46MH-36T6.pdf'},
  {id:'i37',date:'2025-12-01',service:'Visual Studio AI',amount:2999,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_29_11_2025.pdf'},
  {id:'i36',date:'2025-12-01',service:'Gemini',amount:989,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_29_11_2025.pdf'},
  {id:'i35',date:'2025-11-30',service:'ChatGpt Plus',amount:1899,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_29_11_2025.pdf'},
  {id:'i34',date:'2025-11-30',service:'Figma',amount:2999,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_29_11_2025.pdf'},
  {id:'i33',date:'2025-11-29',service:'Syncthing LLC',amount:314,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_29_11_2025.pdf'},
  {id:'i32',date:'2025-11-27',service:'Jet Brains LLC',amount:535,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_25_11_2025.pdf'},
  {id:'i31',date:'2025-11-27',service:'Jet Brains PyCharm',amount:1989,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_25_11_2025.pdf'},
  {id:'i30',date:'2025-11-26',service:'XeAI Perplexity',amount:1555,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_25_11_2025.pdf'},
  {id:'i29',date:'2025-11-25',service:'JetBrains SCO',amount:1679,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_25_11_2025.pdf'},
  {id:'i28',date:'2025-11-25',service:'Open AI Sora',amount:859,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_25_11_2025.pdf'},
  {id:'i27',date:'2025-11-23',service:'Antrophic LLC',amount:899,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_25_11_2025.pdf'},
  {id:'i26',date:'2025-11-23',service:'CompService',amount:1999,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_25_11_2025.pdf'},
  {id:'i25',date:'2025-11-22',service:'Open AI LLC',amount:2065,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_19_11_2025.pdf'},
  {id:'i24',date:'2025-11-22',service:'Firebase AI Studio',amount:1599,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_23_11_2025.pdf'},
  {id:'i23',date:'2025-11-19',service:'Obsidian Vaults',amount:595,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_19_11_2025.pdf'},
  {id:'i22',date:'2025-11-19',service:'Google Cloud Platform Payments',amount:1402,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_19_11_2025.pdf'},
  {id:'i21',date:'2025-11-19',service:'Drive Sync',amount:350,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_19_11_2025.pdf'},
  {id:'i20',date:'2025-11-17',service:'Cursor AI',amount:2114,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_15_11_2025.pdf'},
  {id:'i19',date:'2025-11-17',service:'ChatGpt Plus',amount:1900,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_15_11_2025.pdf'},
  {id:'i18',date:'2025-11-15',service:'Bis24 Payments Uah',amount:387,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_15_11_2025.pdf'},
  {id:'i17',date:'2025-11-15',service:'Google Workspace',amount:412,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_15_11_2025.pdf'},
  {id:'i16',date:'2025-11-13',service:'Music Tools Suno',amount:999,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_13_11_2025.pdf'},
  {id:'i15',date:'2025-11-13',service:'Sonnet Claude',amount:2099,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_13_11_2025.pdf'},
  {id:'i14',date:'2025-11-12',service:'JB Android Studio',amount:2899,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_29_09_2025.pdf'},
  {id:'i13',date:'2025-11-06',service:'Microsoft AzureNet',amount:1126,filename:'receipt_TKAA-2C54-3B1K-AKH3.pdf'},
  {id:'i12',date:'2025-11-05',service:'Firebase AI Developer Studio',amount:1750,filename:'receipt_KHBA-K9M5-6H19-A625.pdf'},
  {id:'i11',date:'2025-11-05',service:'Visual Studio AI Code',amount:3200,filename:'receipt_KHBA-K9M5-6H19-A624.pdf'},
  {id:'i10',date:'2025-11-03',service:'PicsArt',amount:250,filename:'receipt_X6MP-MC3E-X6M7-8E47.pdf'},
  {id:'i9',date:'2025-11-03',service:'Canva Pty Ltd.',amount:920,filename:'receipt_X6MP-MC3E-X6M7-8E48.pdf'},
  {id:'i8',date:'2025-11-02',service:'Visual Studio Code AI',amount:3142,filename:'receipt_MB39-B389-4983-6PAA.pdf'},
  {id:'i7',date:'2025-10-31',service:'Google One (Gemini Pro)',amount:988,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_31_10_2025.pdf'},
  {id:'i6',date:'2025-10-30',service:'Figma Make Enterprise',amount:2999,filename:'receipt_0XHP-M50A-B9C7-N1L4.pdf'},
  {id:'i5',date:'2025-10-29',service:'Open AI Codex CLI',amount:1369,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_29_09_2025.pdf'},
  {id:'i4',date:'2025-10-26',service:'Jet Brains PyCharm',amount:3100,filename:'BIS24_29_09_2025_24_23_84.pdf'},
  {id:'i3',date:'2025-10-23',service:'Jet Brains Web Development Tools',amount:2147,filename:'–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è BIS24_25_09_2025.pdf'},
  {id:'i2',date:'2025-10-10',service:'JB Android Studio',amount:2899,filename:'receipt_BIS24_29_09_2025_36_83.pdf'},
  {id:'i1',date:'2025-10-05',service:'Open AI',amount:2700,filename:'receipt_BIS24_29_09_2025_24_22_34.pdf'},
];

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let P = [];
let selFile='', mode='list', curMonth=new Date().toISOString().slice(0,7);
document.getElementById('fD').value = new Date().toISOString().split('T')[0];

// ‚îÄ‚îÄ Storage helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STORE_KEY = 'payments-data-v1';

async function loadData() {
  try {
    const res = await window.storage.get(STORE_KEY);
    if (res && res.value) {
      P = JSON.parse(res.value);
    } else {
      // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ ‚Äî –∑–∞–ø–æ–ª–Ω—è–µ–º SEED –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
      P = [...SEED];
      await persistData();
    }
  } catch(e) {
    // –•—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ ‚Äî —Ä–∞–±–æ—Ç–∞–µ–º —Å SEED –≤ –ø–∞–º—è—Ç–∏
    P = [...SEED];
  }
  render();
}

async function persistData() {
  try {
    await window.storage.set(STORE_KEY, JSON.stringify(P));
    showToast();
  } catch(e) {
    console.warn('Storage unavailable', e);
  }
}

let toastTimer;
function showToast() {
  const t = document.getElementById('toast');
  t.classList.add('on');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('on'), 1800);
}

// ‚îÄ‚îÄ Icons / Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const IC=[
  [['openai','chatgpt','gpt','codex','sora'],'ü§ñ'],
  [['claude','anthropic','sonnet'],'üü†'],
  [['gemini'],'üîµ'],[['firebase'],'üî•'],[['google'],'üîµ'],
  [['github','copilot'],'‚ö´'],[['cursor'],'‚úèÔ∏è'],
  [['jetbrain','jb android','pycharm','jet bran'],'üß†'],
  [['figma'],'üé®'],[['adobe'],'üÖ∞Ô∏è'],[['azure','microsoft'],'ü™ü'],
  [['suno','music'],'üéµ'],[['canva'],'üñºÔ∏è'],[['picsart','ai image'],'üì∏'],
  [['mistral','perplexity','xeai'],'üí°'],[['android studio'],'üì±'],
  [['visual studio','vscode'],'üíª'],[['hugging'],'ü§ó'],
  [['obsidian'],'üíé'],[['syncthing','drive sync'],'üîÑ'],[['betking'],'üé≤'],
];
function ico(s){const l=(s||'').toLowerCase();for(const[k,v]of IC)if(k.some(x=>l.includes(x)))return v;return'üí≥';}
const MO=['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
const MS=['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
function fa(n){return Number(n).toLocaleString('ru-RU',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fd(d){if(!d)return'‚Äî';const[y,m,day]=d.split('-');return`${parseInt(day)} ${MS[parseInt(m)-1]} ${y}`;}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function hl(text,q){if(!q)return esc(text);const re=new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi');return esc(text).replace(re,'<mark>$1</mark>');}
function keywords(name){const stop=new Set(['ai','llc','inc','ltd','pty','the','and','for','web','app','dev','pro','plus','tools','studio','code','edit','view','smart','bots','payments','uah','com','ua','net','services','platform','development','products','databases','google']);return name.toLowerCase().replace(/[^a-z–∞-—è—ñ—ó—î0-9\s]/gi,' ').split(/\s+/).filter(w=>w.length>=3&&!stop.has(w));}
function findSimilar(p){const kw=keywords(p.service);if(!kw.length)return[];return P.filter(x=>{if(x.id===p.id)return false;const xkw=keywords(x.service);return kw.some(k=>xkw.some(xk=>xk.includes(k)||k.includes(xk)));}).sort((a,b)=>b.date.localeCompare(a.date));}

const SVG_EDIT=`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
const SVG_DEL=`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>`;
const SVG_CLIP=`<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>`;

function cardHTML(p,q){return`<div class="card-main" onclick="toggleCard(this)"><div class="c-ico">${ico(p.service)}</div><div class="c-body"><div class="c-top"><div class="c-name">${hl(p.service,q)}</div><div class="c-amt">‚Ç¥ ${fa(p.amount)}</div></div><div class="c-bot"><span class="c-date">${fd(p.date)}</span>${p.filename?`<span class="c-clip">${SVG_CLIP}</span>`:''}</div></div></div><div class="card-panel">${p.filename?`<div class="panel-filename">${SVG_CLIP} ${esc(p.filename)}</div>`:`<div class="panel-no-file">–ö–≤–∏—Ç–∞–Ω—Ü–∏—è –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∞</div>`}<div class="panel-actions"><button class="pact-btn" data-id="${p.id}" onclick="startEdit(this)">${SVG_EDIT} –†–µ–¥.</button><button class="pact-btn sim" data-id="${p.id}" onclick="toggleSim(this)">üîç –ü–æ—Ö–æ–∂–∏–µ</button><button class="pact-btn del" data-id="${p.id}" onclick="delFromPanel(this)">${SVG_DEL} –£–¥–∞–ª–∏—Ç—å</button></div><div class="similar-list" id="sim_${p.id}"><div class="sim-hdr">–ü–æ—Ö–æ–∂–∏–µ <b></b></div><div class="sim-rows"></div></div></div>`;}

function filteredRows(){let rows=[...P].sort((a,b)=>b.date.localeCompare(a.date));const q=document.getElementById('si').value.trim().toLowerCase();if(mode==='month')rows=rows.filter(r=>r.date.startsWith(curMonth));if(q)rows=rows.filter(r=>r.service.toLowerCase().includes(q)||r.date.includes(q)||fd(r.date).toLowerCase().includes(q)||(r.filename||'').toLowerCase().includes(q));return rows;}

function render(){const el=document.getElementById('list'),emp=document.getElementById('emp');[...el.querySelectorAll('.card,.grp-card')].forEach(c=>c.remove());mode==='group'?renderGroup(el,emp):renderFlat(el,emp);}
function renderFlat(el,emp){const q=document.getElementById('si').value.trim().toLowerCase();const rows=filteredRows();if(!rows.length){emp.classList.add('on');return;}emp.classList.remove('on');const f=document.createDocumentFragment();rows.forEach(p=>{const d=document.createElement('div');d.className='card';d.dataset.id=p.id;d.innerHTML=cardHTML(p,q);f.appendChild(d);});el.insertBefore(f,emp);}
function renderGroup(el,emp){const q=document.getElementById('si').value.trim().toLowerCase();let rows=[...P].sort((a,b)=>b.date.localeCompare(a.date));if(q)rows=rows.filter(r=>r.service.toLowerCase().includes(q)||(r.filename||'').toLowerCase().includes(q));const map=new Map();rows.forEach(r=>{if(!map.has(r.service))map.set(r.service,[]);map.get(r.service).push(r);});const groups=[...map.entries()].sort((a,b)=>b[1][0].date.localeCompare(a[1][0].date));if(!groups.length){emp.classList.add('on');return;}emp.classList.remove('on');const f=document.createDocumentFragment();groups.forEach(([name,items])=>{const gc=document.createElement('div');gc.className='grp-card';gc.innerHTML=`<div class="grp-hdr" onclick="this.closest('.grp-card').classList.toggle('open')"><div class="c-ico">${ico(name)}</div><div class="c-body"><div class="c-name">${hl(name,q)}</div></div><span class="grp-count">${items.length}√ó</span><svg class="grp-arrow" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg></div><div class="grp-body">${items.map(it=>`<div class="grp-row"><div class="grp-row-left"><div class="grp-row-date">${fd(it.date)}</div>${it.filename?`<div class="grp-row-file">${SVG_CLIP} ${esc(it.filename)}</div>`:''}</div><div class="grp-row-amt">‚Ç¥ ${fa(it.amount)}</div><button class="pact-btn" data-id="${it.id}" onclick="startEdit(this)" style="flex:none;padding:6px 8px;margin-left:6px">${SVG_EDIT}</button></div>`).join('')}</div>`;f.appendChild(gc);});el.insertBefore(f,emp);}

function toggleCard(m){const card=m.closest('.card');const was=card.classList.contains('expanded');document.querySelectorAll('.card.expanded').forEach(c=>{c.classList.remove('expanded');c.querySelectorAll('.similar-list').forEach(s=>s.classList.remove('on'));});if(!was)card.classList.add('expanded');}
function toggleSim(btn){const id=btn.dataset.id;const p=P.find(x=>x.id===id);if(!p)return;const el=document.getElementById('sim_'+id);if(el.classList.contains('on')){el.classList.remove('on');return;}const sim=findSimilar(p);el.querySelector('.sim-hdr b').textContent=`(${sim.length})`;const re=el.querySelector('.sim-rows');re.innerHTML=!sim.length?`<div class="sim-none">–ü–æ—Ö–æ–∂–∏—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`:sim.map(s=>`<div class="sim-row"><div class="sim-ico">${ico(s.service)}</div><div class="sim-body"><div class="sim-name">${esc(s.service)}</div><div class="sim-date">${fd(s.date)}</div></div><div class="sim-amt">‚Ç¥ ${fa(s.amount)}</div></div>`).join('');el.classList.add('on');}

function delFromPanel(btn){const id=btn.dataset.id;const card=btn.closest('.card');card.classList.add('rm');setTimeout(async ()=>{P=P.filter(x=>x.id!==id);await persistData();render();},230);}

function setMode(m,el){mode=m;document.querySelectorAll('.mtab').forEach(t=>t.classList.remove('on'));el.classList.add('on');const nav=document.getElementById('monthNav');if(m==='month'){nav.classList.add('on');updateMonthLbl();}else nav.classList.remove('on');render();}
function shiftMonth(dir){const[y,m]=curMonth.split('-').map(Number);const d=new Date(y,m-1+dir,1);curMonth=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;updateMonthLbl();render();}
function updateMonthLbl(){const[y,m]=curMonth.split('-');document.getElementById('monthLbl').textContent=`${MO[parseInt(m)-1]} ${y}`;}

document.getElementById('si').addEventListener('input',function(){document.getElementById('sx').classList.toggle('on',this.value.trim().length>0);render();});
function clrS(){document.getElementById('si').value='';document.getElementById('sx').classList.remove('on');render();}

let shOpen=false;
function toggleSh(){shOpen?closeSh():openSh(false);}
function openSh(isEdit){shOpen=true;document.getElementById('sh').classList.add('on');document.getElementById('ovl').classList.add('on');document.getElementById('fab').classList.add('open');document.getElementById('shTitle').textContent=isEdit?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å':'–ù–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂';if(!isEdit)setTimeout(()=>document.getElementById('fS').focus(),340);}
function closeSh(){shOpen=false;document.getElementById('sh').classList.remove('on');document.getElementById('ovl').classList.remove('on');document.getElementById('fab').classList.remove('open');document.getElementById('editId').value='';document.getElementById('fS').value='';document.getElementById('fA').value='';document.getElementById('fD').value=new Date().toISOString().split('T')[0];document.getElementById('ff').value='';document.getElementById('ufn').textContent='';document.getElementById('uz').classList.remove('has');selFile='';}
function startEdit(btn){const id=btn.dataset.id;const p=P.find(x=>x.id===id);if(!p)return;document.getElementById('editId').value=id;document.getElementById('fS').value=p.service;document.getElementById('fA').value=p.amount;document.getElementById('fD').value=p.date;if(p.filename){document.getElementById('ufn').textContent=p.filename;document.getElementById('uz').classList.add('has');selFile=p.filename;}openSh(true);}
function onF(inp){const f=inp.files[0];if(!f){selFile='';return;}selFile=f.name;document.getElementById('ufn').textContent=f.name;document.getElementById('uz').classList.add('has');}

async function saveEntry(){
  const svc=document.getElementById('fS').value.trim();
  const amt=document.getElementById('fA').value;
  const dt=document.getElementById('fD').value;
  const eid=document.getElementById('editId').value;
  if(!svc){shake('fS');return;}
  if(!amt||isNaN(amt)||Number(amt)<=0){shake('fA');return;}
  if(!dt){shake('fD');return;}
  if(eid){
    const idx=P.findIndex(x=>x.id===eid);
    if(idx>-1)P[idx]={...P[idx],service:svc,amount:parseFloat(amt),date:dt,filename:selFile||P[idx].filename};
  } else {
    P.unshift({id:'n'+Date.now().toString(36),service:svc,amount:parseFloat(amt),date:dt,filename:selFile||''});
  }
  await persistData(); // ‚Üê –°–û–•–†–ê–ù–Ø–ï–ú –°–†–ê–ó–£
  closeSh();
  render();
}

function shake(id){const el=document.getElementById(id);el.style.borderColor='var(--red)';el.animate([{transform:'translateX(-5px)'},{transform:'translateX(5px)'},{transform:'translateX(0)'}],{duration:250});setTimeout(()=>el.style.borderColor='',800);el.focus();}

function importX(inp){const f=inp.files[0];if(!f)return;document.getElementById('xfn').textContent='–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶';loadXLSX().then(()=>{document.getElementById('xfn').textContent='–ß–∏—Ç–∞—é‚Ä¶';const r=new FileReader();r.onload=async e=>{try{const wb=XLSX.read(e.target.result,{type:'array',cellDates:true});const ws=wb.Sheets[wb.SheetNames[0]];const rows=XLSX.utils.sheet_to_json(ws,{header:1});let n=0;rows.slice(1).forEach(row=>{let d=row[0],ds='';if(d instanceof Date)ds=d.toISOString().split('T')[0];else if(typeof d==='string')ds=d.trim();else if(typeof d==='number'){const dt=new Date(Math.round((d-25569)*86400*1000));ds=dt.toISOString().split('T')[0];}if(!ds)return;const svc=String(row[1]||'').trim();if(!svc)return;const amt=parseFloat(String(row[2]||'0').replace(',','.'));const fn=String(row[3]||'').trim();const dup=P.some(x=>x.date===ds&&x.service===svc&&Number(x.amount)===amt);if(!dup){P.push({id:'x'+Date.now().toString(36)+Math.random().toString(36).slice(2),date:ds,service:svc,amount:amt,filename:fn});n++;}});await persistData();document.getElementById('xfn').textContent=`‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ ${n} –Ω–æ–≤—ã—Ö`;document.getElementById('xz').classList.add('has');closeSh();render();}catch(err){document.getElementById('xfn').textContent='–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞';}};r.readAsArrayBuffer(f);}).catch(()=>{document.getElementById('xfn').textContent='–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞';});}

function exportXlsx(){loadXLSX().then(()=>{const rows=filteredRows();const data=[['–î–∞—Ç–∞','–°–µ—Ä–≤–∏—Å','–°—É–º–º–∞','–ò–º—è —Ñ–∞–π–ª–∞'],...rows.map(r=>[r.date,r.service,r.amount,r.filename||''])];const ws=XLSX.utils.aoa_to_sheet(data);ws['!cols']=[{wch:12},{wch:36},{wch:12},{wch:42}];const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'payments');XLSX.writeFile(wb,`Payments${mode==='month'?'_'+curMonth:''}.xlsx`);}).catch(()=>alert('–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞'));}

document.addEventListener('keydown',e=>{if(e.key==='Escape'&&shOpen)closeSh();});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadData(); // –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
</script>
</body>
</html>